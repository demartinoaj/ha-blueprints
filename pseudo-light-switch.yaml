blueprint:
  name: Pseudo Light Switch
  description: Virtually link A Zigbee2MQTT Switch to a Light entity, only using button press events to control the light
  domain: automation
  input:
    switch_action:
      name: Switch Action Sensor
      description: Action sensor generated by the Zigbee2MQTT integration
      selector:
        entity:
          multiple: false
          filter:
            - domain: event
    linked_light:
      name: Linked Light
      selector:
        entity:
            multiple: false
            filter:
                - domain: light
    brightness_step:
      name: Brightness Step
      description: Brightness adjustment step (slider percentage, 1-100%).
      default: 7
      selector:
        number:
          min: 1.0
          max: 100.0
          step: 1.0
          unit_of_measurement: '%'
          mode: slider
    delay_ms:
      name: Delay (ms) Between Steps
      description: Delay in milliseconds between brightness adjustment steps.
      default: 400
      selector:
        number:
          min: 100.0
          max: 5000.0
          step: 100.0
          unit_of_measurement: ms
          mode: slider

mode: single # this way holding the button for brightness can't be interrupted.
variables:
  brightness_step: !input brightness_step # need varrible to do math on this for decrease brighness
trigger:
  - platform: state
    entity_id: !input switch_action
condition: []
action:
  - choose:
      - conditions:
            - condition: state
              entity_id: !input switch_action
              attribute: event_type
              state: "brightness_move_up"
        sequence:
          - repeat:
              sequence:
              - action: light.turn_on
                metadata: {}
                data:
                  brightness_step_pct: !input brightness_step
                  entity_id: !input linked_light
              - delay:
                  hours: 0
                  minutes: 0
                  seconds: 0
                  milliseconds: !input delay_ms
              until:
              - condition: state
                entity_id: !input switch_action
                attribute: event_type
                state: brightness_stop
      - conditions:
            - condition: state
              entity_id: !input switch_action
              attribute: event_type
              state: "brightness_move_down"
        sequence:
          - repeat:
              sequence:
              - action: light.turn_on
                metadata: {}
                data:
                  brightness_step_pct: "{{ 0 - brightness_step}}"
                  entity_id: !input linked_light
              - delay:
                  hours: 0
                  minutes: 0
                  seconds: 0
                  milliseconds: !input delay_ms
              until:
              - condition: state
                entity_id: !input switch_action
                attribute: event_type
                state: brightness_stop
      - conditions:
            - condition: state
              entity_id: !input switch_action
              attribute: event_type
              state: "on"
        sequence:
          - action: light.turn_on
            metadata: {}
            data:
              brightness_pct: 100
              entity_id: !input linked_light
      - conditions:
            - condition: state
              entity_id: !input switch_action
              attribute: event_type
              state: "off"
        sequence:
          - action: light.turn_off
            metadata: {}
            data:
              entity_id: !input linked_light